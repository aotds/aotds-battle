<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">lib/battle/weapons.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pino">pino</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">battle</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rig_dice">rig_dice</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-roll_dice">roll_dice</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-saga">saga</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-relative_coords">relative_coords</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-weapon_fire">weapon_fire</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-rigged_dice">rigged_dice</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">battle/Reducer</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-LogReducer">LogReducer</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/battle/weapons.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import _ from &apos;lodash&apos;;

import { roll_dice } from &apos;./dice&apos;;

import JsonSchemaValidator from &apos;../json-schema-type-checking&apos;;
import schemas from &apos;./schema&apos;;
import Action from &apos;./Actions&apos;;

const { with_args, returns, with_context, with_return } = JsonSchemaValidator({
    schemas
});

export
function relative_coords(ship, target ) {
    let result = {};
    let relative = _.zip
        .apply(null, [ship, target].map(function (s) { return s.coords; }))
        .map(function (x) { return x[1] - x[0]; });

    result.angle = Math.atan2(relative[0], relative[1])
        * 180 / Math.PI;

    result.bearing = result.angle - ship.heading;

    result.distance = Math.sqrt(relative.map(function (x) { return Math.pow(x, 2); })
        .reduce(function (a, b) { return a + b; }));

    result.angle = _.round( result.angle, 0 );
    result.bearing = _.round( result.bearing, 0 );
    result.distance = _.round( result.distance, 2 );

    return result;
}

const arcs = {
    F:  [ -30, 30 ],
    FP: [ -90, -30 ],
    FS: [ 30, 90 ],
    AS: [ 90, 150 ],
    A:  [ -150, 150 ],
    AF: [ -150, -90 ],
};

export const weapon_fire = function* (attacker, target, weapon) {
    // right now it&apos;s all beam weapons
    var weapon_fired = Action.weapon_fired({
        object_id: attacker.id,
        target_id: target.id,
        weapon_id: weapon.id,
    });

    let { distance, bearing } = relative_coords(attacker, target);

    weapon_fired.distance = distance;
    weapon_fired.bearing = bearing;

    let in_weapon_arc = bearing =&gt; 
        weapon.arcs.map( x =&gt; arcs[x] )
            .some( arc =&gt; _.inRange( bearing, ...arc ) );

    if( ! in_weapon_arc( bearing ) ) {
        weapon_fired.no_firing_arc = true;
        return actions;
    }

    var nbr_dice = weapon.class - Math.trunc(distance / 12);

    if (nbr_dice &lt;= 0) {
        nbr_dice = 0;
        weapon_fired.out_of_range = true;
    }

    var dice = roll_dice(nbr_dice);

    var penetrating = roll_dice(dice.filter(function (d) { return d == 6; }).length, { reroll: [6] });

    weapon_fired.dice = dice;

    weapon_fired.dice_penetrating = penetrating;

    yield weapon_fired;

    // split the damage calculation apart?

    var table = { 4: 1, 5: 1, 6: 2 };
    var damage = _.sum(dice.map(function (d) { return table[d] || 0; }));
    if (damage &gt; 0) {
        yield {
            type: &apos;DAMAGE&apos;,
            object_id: target.id,
            damage
        };
    }
    damage = _.sum(penetrating.map(function (d) { return table[d] || 0; }));
    if (damage &gt; 0) {
        yield {
            type: &apos;DAMAGE&apos;,
            is_penetrating: true,
            object_id: target.id,
            damage
        };
    }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
